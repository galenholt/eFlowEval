---
title: "Vegetation appendix"
author: "Galen Holt"
format: 
  docx: 
    reference-doc: mer_template.docx
    df-print: kable
# format: 
#   html:
#     embed-resources: true
editor: visual
execute: 
  echo: false
  message: false
bibliography: references.bib
---

# Supplementary material E. Aquatic macrophyte demonstration

```{r setup}
# set the root to the project directory, not the rmd directory
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r}
#| message: false
# libraries
library(tidyverse)
library(sf)
library(stars)
library(colorspace)
library(patchwork)
library(units)
library(knitr)
```

```{r}
#| output: false
#| message: false
# source in the data management

source('directorySet.R')
source(file.path('Scripts', 'Scenarios', 'plotting', 'vegPlotSetup_Basin.R'))
# Directory to export TO
scriptOut <- file.path('strictOut', 'vegetation', 'basin')
if (!dir.exists(scriptOut)) {dir.create(scriptOut, recursive = TRUE)}
```

```{r}
#| message: false
# Get the data in- run the prep function
veg_catch <- veg_yr_prep(datOut = datOut)

# also want the anaes
load(file.path(datOut, 'Vegmapping', 'lippia_anae.rdata'))
load(file.path(datOut, 'Vegmapping', 'centipeda_anae.rdata'))
```

```{r}
#| label: create-dataframes
#| message: false
# I think I can do most of the dependent stuff with the *_cat dataframes, so make my life easier, and order strict_level as a factor and cut off the surv_Lippia because I'm just interested in the sequential steps for now, I think.If we want the individual strictures, we should return all of them, not just this one.

lippia <- veg_catch$lippia$lippiadf_cat %>% 
  filter(strict_level != 'surv_Lippia') %>% 
  mutate(strict_level_F = case_when(strict_level == 'germ_Lippia' ~ "Germ",
                                    strict_level == 'germSurv_Lippia' ~ "Germ and surv",
                                    strict_level == 'fullCycle_anae_lippia' ~ "Germ, surv, habitat")) %>% 
  mutate(strict_level_F = factor(strict_level_F, 
                               levels = c('Germ', 
                                          'Germ and surv',
                                          'Germ, surv, habitat') ))

centipeda <- veg_catch$centipeda$centipedadf_cat %>%
  mutate(strict_level_F = case_when(strict_level == 'seedsurv_centipeda' ~ "Seed surv",
                                     strict_level == 'seedsurv_germ_centipeda' ~ 'Seed surv and germ',
                                     strict_level == 'seedsurv_germ_fruit_centipeda' ~ 'Seed surv, germ, fruit',
                                     strict_level == 'fullCycle_anae_centipeda' ~ 'Seed surv, germ, fruit, habitat',
                                     strict_level == 'fullCycle_lippiaLimit_centipeda' ~ 'All and lippia competition')) %>% 
  mutate(strict_level_F = factor(strict_level_F, 
                               levels = c('Seed surv',
                                          'Seed surv and germ',
                                          'Seed surv, germ, fruit',
                                          'Seed surv, germ, fruit, habitat',
                                          'All and lippia competition') ))
```

```{r}
#| label: lippia-conditional-datasetup
#| message: false

# We already have everything proportional to wetlands in `proportion_wetlands` column
# These are sequential loss
comp_gs_g <- lippia  %>% 
  baseline(comp_col = strict_level, baselev = 'germ_Lippia', groupers = c(date, ValleyName), val_col = area_passing, FUN = relative) %>% 
  filter(strict_level == 'germSurv_Lippia')

names(comp_gs_g)[str_detect(names(comp_gs_g), 'relative')] <- 'Proportional_area'

comp_f_gs <- lippia  %>% 
  baseline(comp_col = strict_level, baselev = 'germSurv_Lippia', groupers = c(date, ValleyName), val_col = area_passing, FUN = relative) %>% 
  filter(strict_level == 'fullCycle_anae_lippia')

names(comp_f_gs)[str_detect(names(comp_f_gs), 'relative')] <- 'Proportional_area'


# Mostly just a bind_rows, but need to modify step 1, since we didn't rebuild that frame above
sequential_lippia <- lippia  %>% 
  filter(strict_level == 'germ_Lippia') %>% 
  select(Proportional_area = proportion_wetlands, everything()) %>% 
  bind_rows(comp_gs_g, comp_f_gs)
```

```{r}
#| label: centipeda-conditional-datasetup
#| output: false
#| message: false
# Why don't I bind_rows these and then use facets?
# We already have everything proportional to wetlands in `proportion_wetlands` column

# These are sequential loss
comp_gss_ss <- centipeda  %>% 
  baseline(comp_col = strict_level, baselev = 'seedsurv_centipeda', 
           groupers = c(date, ValleyName), 
           val_col = area_passing, FUN = relative) %>% 
  filter(strict_level == 'seedsurv_germ_centipeda')

names(comp_gss_ss)[str_detect(names(comp_gss_ss), 'relative')] <- 'Proportional_area'

comp_f_gss <- centipeda  %>% 
  baseline(comp_col = strict_level, baselev = 'seedsurv_germ_centipeda', groupers = c(date, ValleyName), val_col = area_passing, FUN = relative) %>% 
  filter(strict_level == 'seedsurv_germ_fruit_centipeda')

names(comp_f_gss)[str_detect(names(comp_f_gss), 'relative')] <- 'Proportional_area'

comp_an_f <- centipeda  %>% 
  baseline(comp_col = strict_level, baselev = 'seedsurv_germ_fruit_centipeda', groupers = c(date, ValleyName), val_col = area_passing, FUN = relative) %>% 
  filter(strict_level == 'fullCycle_anae_centipeda')

names(comp_an_f)[str_detect(names(comp_an_f), 'relative')] <- 'Proportional_area'

comp_l_an <- centipeda  %>% 
  baseline(comp_col = strict_level, baselev = 'fullCycle_anae_centipeda', groupers = c(date, ValleyName), val_col = area_passing, FUN = relative) %>% 
  filter(strict_level == 'fullCycle_lippiaLimit_centipeda')

names(comp_l_an)[str_detect(names(comp_l_an), 'relative')] <- 'Proportional_area'

# Mostly just a bind_rows, but need to modify step 1, since we didn't rebuild that frame above
sequential_cent <- centipeda  %>% 
  filter(strict_level == 'seedsurv_centipeda') %>% 
  select(Proportional_area = proportion_wetlands, everything()) %>% 
  bind_rows(comp_gss_ss, comp_f_gss, comp_an_f, comp_l_an)
```

```{r}
demo_year <- 2016
catch_subset <- c('Avoca', 'Lachlan', 'Lower Murray', 'Paroo', 'Wimmera')
```

To demonstrate the eFlowEval framework for dependent strictures both within a species and across species, we develop a set of strictures based on the life history of two plants, *Phyla nodiflora* (Lippia) and *Centipeda cunninghamii*. We use this demonstration to illustrate not only dependence between species, but also the capability of the eFlowEval framework for the rolling temporal lookbacks needed for modelling life history periods, as well as demonstrate potential outputs and uses for the framework.

The two demonstration species are flowering wetland plants, with Lippia being a competitive dominant invasive species and *C. cunninghamii* a native. Both depend on inundation, as well as other strictures throughout their life cycles. We worked with experts in the Vegetation theme, particularly Cherie Campbell, Will Higgisson and Fiona Dyer to establish plausible strictures for these species based on their known ecology in the Lachlan catchment. Their life histories are more complex than represented here, but the goal was to capture the available knowledge of the dominant strictures for this demonstration.

## E.1 Data and strictures

The underlying driver data and its processing depend on the nature of the strictures, and so we discuss the strictures and data processing in tandem. Because of the nature of the bimonthly inundation data, all dependent strictures were calculated on the bimonthly scale. This necessitated temporal aggregation of strictures dependent on soil temperature and moisture. The relevant aggregation function was chosen to account for the definition of the inundation as the maximum extent, as well as the meaning of each stricture, as described for the individual strictures below.

### Lippia

#### Stricture 1: Germination

For Lippia, the first stricture was that germination is highest in temperatures ranging from 25C to 35C during the day. To assess this stricture, we used the area-weighted average soil temperatures for each polygon from NASA MODIS created for the metabolism demonstration. We assigned a passing value to each polygon on each day if the temperature was in the band from 25 to 35C. In addition to the binary pass/fail for each polygon, we also returned the area of passing polygons (or zero for those that failed) to give the area passing the germination stricture on each day. To create bimonthly data to use for dependent strictures involving inundation, we calculated the maximum area passing the germination stricture for each polygon over each bimonthly period of the inundation data. This approach parallels the inundation data itself, yielding the maximum extent of germination.

#### Stricture 2: Survival of growing plants

Once plants germinate, they need to survive to complete their life cycle. Our second stricture captures the information that extended floods of \>30cm depth kill adult plants. This stricture therefore utilised the inundation dataset used for the metabolism and waterbird demonstrations, but processed into the ANAE polygons with a different aggregation function, this time calculating the area of each polygon with inundation pixels \> 0 but \< 30 cm depth. This is likely an underestimate of survival, since the data provides the maximum extent of inundation over the two-month period, and some proportion of that inundation will not have persisted long enough to cause mortality. Better resolution on this stricture would require better data resolution than is currently available. This stricture is based on the bimonthly inundation dataset, so does not need to be temporally aggregated.

#### Stricture 3: Habitat type

The ANAE polygons are defined by wetland habitat type. As in the waterbird demonstration, we established a habitat type stricture, limiting Lippia success to only a subset of the possible wetlands in the basin. To construct this stricture, we accessed all observation records from the Atlas of Living Australia (https://www.ala.org.au/ on 17 March 2023) for *Lippia* and *Phyla nodiflora,* yielding 450 records. These records were spatially matched them to the ANAE polygons. The habitat types were then recorded for all polygons with an associated ALA record. These habitat types were then classes as 'passing' (`r nrow(lippia_anae_types)`, @tbl-lippia-anae ) while all others were 'failing'. Any polygon with a passing habitat type yielded a passing habitat stricture, whether or not that particular polygon had an ALA record; the test here is whether the habitat type is one that Lippia can persist in.

```{r}
#| label: tbl-lippia-anae
#| tbl-cap: ANAE types with at least one record of Lippia or Phyla nodiflora from ALA.
lippia_anae_types
```

#### Dependence

The above strictures are defined separately, but the first two define life-cycle relationships. Thus, additional processing is needed to address their dependence. Specifically, when assessing survival, we ask whether there was any preceding germination- were there any growing individuals available to survive? To test passing the germination and survival strictures, we therefore calculate a rolling lookback for germination over the preceding year, and only return the area of survival if germination occurred in the previous year.

The above then gives the life-cycle strictures, and so estimates the areas of germination and survival in the absence of any limitation of habitat. Those records were then multiplied by 1 or 0 depending on whether each ANAE polygon met the habitat type stricture to give the full set of outcomes for Lippia.

### Centipeda cunninghamii

#### Stricture 1: Seed survival

The first stricture for *Centipeda cunninghamii* is seed survival, with seeds losing viability at temperatures above 60C. To assess this stricture, we used the soil temperature data aggregated into ANAE polygons also used for the metabolism demonstration and the Lippia germination stricture. To pass the seed survival stricture on a given day, we ask if the soil temperatures have been above 60C for 4 days or fewer in the last month, under the assumption that a single day is unlikely to cause complete failure. In part, these choices were made to demonstrate the capability of the eFlowEval to do complex lookback dependencies (e.g. some number of days meeting a condition within a timespan), while reflecting limited knowledge about the strictures. Ideally, this lookback period would reflect dispersal periods or soil turnover periods to expose new seeds, and might include intervening dispersal events such as floods in a more complex set of strictures. This stricture yields a pass/fail for each wetland, which can be multiplied by its area to give area of passing. To create bimonthly data to use for dependent strictures, we find the minimum seed survival area over the bimonthly periods defined by the inundation data, setting seed survival to zero if seed mortality occurred during the two-month period.

#### Stricture 2: Germination

To continue the life cycle, seeds that survive need to germinate, which requires a period of sustained inundation. We use the area of inundation values for each wetland calculated for the metabolism demonstration here to give an area of successful germination in each wetland for each bimonthly period in the inundation data. This is necessarily a coarse estimate with error in both directions- germination likely requires inundation for a shorter period than two months, while the inundation data is the maximal extent over two months, and so some amount of that area may be inundated for much less time. This stricture depends on the bimonthly inundation data, and so is not temporally aggregated for dependent strictures.

#### Stricture 3: Survival until fruiting

The final life-cycle stricture for *C. cunninghamii* requires soil moisture persistence during a growing period to allow the growing plants to reach maturity. The underlying dataset is obtained from the Australian Bureau of Meterorology AWRA-L soil moisture model, @australi . This dataset provides daily raster values for percent soil moisture in the root zone with pixels of 0.05 degrees on a side. Considered independently, this stricture requires soil moisture above 10% for 42 days as an estimate of a minimum growing period. WHERE ON EARTH DID 42 DAYS COME FROM? To demonstrate eFlowEval capability, these rolling lookback calculations were done on the input raster data itself, rather than after the raster data was aggregated into polygons (as is done elsewhere with rolling lookbacks). This yielded a raster grid with daily values of minimum soil moisture over the preceding 42 days. These were then given passing values if they were above 10%, and aggregated into ANAE polygons to give the area of passing raster cells within each polygon. Like the seed survival stricture, to prepare these strictures for dependence, we aggregate them to the bimonthly scale of the inundation data with the minimum. Death at any point during the two-month period yields a failure for the period.

#### Stricture 4: Habitat type

As with Lippia, we established a habitat type stricture limiting *C. cunninghamii* success to only a subset of the possible wetlands in the basin. To construct this stricture, we accessed all observation records from the Atlas of Living Australia for *Centipeda cunninghamii* (14097 records), and spatially matched them to the ANAE polygons. As with Lippia, habitat types with spatially-matching ALA records were then classed as 'passing', while all others were 'failing'. Any polygon with a passing habitat type yielded a passing habitat stricture, whether or not that particular polygon had an ALA record; the test here is whether the habitat type is one that *C. cunninghamii* can persist in, of which there were `r nrow(centipeda_anae_types)`,( @tbl-cent-anae ).

```{r}
#| label: tbl-cent-anae
#| tbl-cap: ANAE types with at least one record of Centipeda cunninghamii from ALA.
centipeda_anae_types
```

#### Stricture 5: Competition (Lippia)

The final demonstration stricture for *C. cunninghamii* is limitation by a superior competitor, in this case represented by Lippia. For this demonstration, any polygon with success through the final Lippia stricture (e.g. complete Lippia life-cycle success) during the preceding year is a failure for *C. cunninghamii*.

#### Dependence

To pass seed survival and germination, the germination stricture is multiplied by whether the seed survival stricture passed, e.g. whether there were seeds present to germinate. Here, because germination occurs directly from seeds, there is no lookback period except that built into the seed survival itself.

The fruiting stricture depends on preceding germination, as well as survival through a growing period. To model this dependence, we ask whether the seed survival and germination stricture passed during the preceding year, ignoring the immediately preceding month to enforce a minimal growing period of one month. Then, if there was successful germination in the past year, we ask if the soil moisture stricture has remained passing during that time, allowing continued growth to fruiting, and the area of success is the minimum area of the germination and fruiting strictures.

As with Lippia, the values in each polygons are then multiplied by 1 or 0 depending on whether that polygon's ANAE type matches the habitat strictutre.

The above yields the modelled favourability in the absence of Lippia, a dominant invasive. To capture the effect of Lippia, we aggregate the final Lippia model to the preceding year, asking whether Lippia successfully completed its life cycle during the preceding year. If it did, then we model *C. cunninghamii* being outcompeted by setting the value of that polygon to zero- Lippia success prevents *C. cunninghamii* from completing its life cycle.

## E.2 Additional results

Here, we provide additional results to provide additional examples of how strictures could be visualized and provide additional detail about the strictures and their outcomes. We also provide visualisations of Lippia strictures complementing those for *C. cunninghamii* in the text. The text primarily discusses *C. cunninghamii* results, as they are the best demonstration of dependent strictures. The same plots and analyses are available for Lippia. In addition to providing a stricture analysis for Lippia favourability across the basin, the complete set of Lippia results provides the "Lippia" stricture that represents competitive limitation of *C. cunninghamii*, and so helps interpret those results. We also provide here some additional plots to further explore the strictures and their dependencies.

### Outcome variables and plots

#### Absolute and proportional favourability

In the metabolism demonstration, we presented most data in terms of total metabolic activity, while for the vegetation demonstration in the text, we present outcomes scaled to the area of wetlands. Both outcomes are informative and can be calculated for both demonstrations. Totals across the wetlands provide important information about the total biomass or total production- the absolute amount of whatever the outcome is. Considering the proportion, in contrast, scales the outcomes by area (or other scaling factor), illuminating how much of the available habitat is successful. We have chosen here to display metabolic activity as a total and vegetation favourability proportionally, as these measures likely better reflect quantities relevant to management of the different resources. However, either outcome can by provided.

#### Compounding strictures

To better understand the compounding of strictures, we can look at the proportional loss of area between strictures- e.g. instead of looking at the proportion of wetland area utilized, we can look at the wetland area utilised as a fraction of that used in the preceding step. This measures the impact of each successive stricture on the remaining area of favourability (shown in middle row of Figure 7 in the text for *C. cunninghamii*. Unlike the measure above proportional to total wetland area, the point here is the sequential loss- e.g. what proportion of area remaining is lost with each subsequent stricture, the conditional loss.

#### Plots

We can present any of these outcomes as maps, bar plots, timeseries, and many others. Here, we provide a sampling of those presentations to provide more detail about how the vegetation strictures operate and some additional examples of how different presentation choices provide different benefits and insights to managers.

### Lippia

For Lippia (@fig-lippia-area ), the area of favourability varies dramatically among catchments. This area changes little as we add strictures, indicating that each additional level of dependency through the life cycle does not restrict the area of favourability much.

```{r}
#| label: fig-lippia-area
#| fig-cap: !expr glue::glue("Area of Lippia favourability following each successive stricture. Example given for water year {demo_year}")

lippia_area <- lippia %>% 
  filter(waterYear == demo_year) %>% 
ggplot() +
  geom_sf(mapping = aes(fill = area_passing/10000)) +
  facet_wrap('strict_level_F') +
  scale_fill_continuous_sequential(palette = 'Turku', trans = 'log10') +
  labs(fill = 'Hectares\npassing') +
  theme(legend.position = 'bottom')

ggsave(file.path(scriptOut, 'lippia_area.pdf'),
       plot = lippia_area,
       width = 12, height = 6, units = 'cm')
ggsave(file.path(scriptOut, 'lippia_area.png'),
       plot = lippia_area,
       width = 12, height = 6, units = 'cm')

lippia_area
```

We can also make bar plots of this data ( @fig-lippia-bar ), which helps see small differences. Unlike the text, where we focused on a subset of catchments, here we provide all of them. This plot is ordered by catchment area on the x-axis, and we see that there is a clear correlation, but by no means perfectly- some of the larger catchments don't have similarly large areas of wetlands.

```{r}
#| label: fig-lippia-bar
#| fig-cap: !expr glue::glue("Area of wetlands favourable for Lippia following each successive stricture. Example given for water year {demo_year}")
lippia_area_bar <- lippia %>% 
  filter(waterYear == demo_year) %>% 
ggplot() +
  geom_col(mapping = aes(x = fct_reorder(ValleyName, catchment_area), 
                         y = area_passing/10000, 
                         fill = strict_level_F),
           position = position_dodge()) +
  scale_fill_discrete_qualitative(palette = 'Dark2') +
  labs(fill = 'Stricture', y = 'Hectares passing', x = NULL) +
  theme(legend.position = 'bottom') +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))


ggsave(file.path(scriptOut, 'lippia_area_bar.pdf'),
       plot = lippia_area_bar,
       width = 12, height = 6, units = 'cm')
ggsave(file.path(scriptOut, 'lippia_area_bar.png'),
       plot = lippia_area_bar,
       width = 12, height = 6, units = 'cm')

lippia_area_bar
```

It is clear that the area of favourability is closely correlated to catchment area, unsurprisingly. To better understand the biology underlying this total amount of Lippia success, we can recognise that the area of wetland habitat limits the potential area, and this area of wetland habitat varies across the basin (with catchment size and other factors). We thus calculate the area of successful wetlands proportional to the total wetland area in each catchment ( @fig-lippia-prop ) paralleling the *C. cunninghamii* results shown in the top row of Figure 7 in the text).

Through the first two strictures (germination and survival), nearly 100% of the wetlands across the basin are successful. The third stricture (habitat type) reduces success some, but predominantly in the smaller basins, and even the 'worst' catchments have 60% of their wetlands favourable for *Lippia* with these strictures. As we see above, these smaller catchments contribute little to the total *Lippia* success in the basin. Note the catchments with low Lippia success along the southern edge of the basin- this is why they are the only catchments to avoid the major drops in *C. cunninghamii* success following the "Lippia" stricture.

```{r}
#| label: fig-lippia-prop
#| fig-cap: !expr glue::glue("Area of wetlands favourable for Lippia following each successive stricture, proportional to total wetland are in each catchment. Example given for water year {demo_year}")

lippia_prop <- lippia %>% 
  filter(waterYear == demo_year) %>% 
ggplot() +
  geom_sf(mapping = aes(fill = proportion_wetlands)) +
  facet_wrap('strict_level_F') +
  scale_fill_continuous_sequential(palette = 'YlGnBu') + 
  labs(fill = 'Proportion\nwetland area\nsuccessful') +
  theme(legend.position = 'bottom')


ggsave(file.path(scriptOut, 'lippia_prop.pdf'),
       plot = lippia_prop,
       width = 12, height = 6, units = 'cm')
ggsave(file.path(scriptOut, 'lippia_prop.png'),
       plot = lippia_prop,
       width = 12, height = 6, units = 'cm')

lippia_prop
```

A bar plot of the proportion of wetlands favourable for Lippia clearly shows thesame message as the maps- nearly all wetlands are favourable for *Lippia* based on germination and survival conditions, but they differ in the fraction of those wetlands that are of a favourable habitat type.

```{r}
#| label: fig-lippia-prop-bar
#| fig-cap: !expr glue::glue("Area of wetlands favourable for Lippia following each successive stricture, proportional to total wetland are in each catchment. Example given for water year {demo_year}. Catchments ordered by catchment area.")

lippia_prop_bar <- lippia %>% 
  filter(waterYear == demo_year) %>% 
ggplot() +
  geom_col(mapping = aes(x = fct_reorder(ValleyName, wetland_area), 
                         y = proportion_wetlands, 
                         fill = strict_level_F),
           position = position_dodge()) +
  scale_fill_discrete_qualitative(palette = 'Dark2') +
  labs(fill = 'Stricture', y = 'Proportion wetland area\nsuccessful', x = NULL) +
  theme(legend.position = 'bottom') +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))

ggsave(file.path(scriptOut, 'lippia_prop_bar.pdf'),
       plot = lippia_prop_bar,
       width = 12, height = 6, units = 'cm')
ggsave(file.path(scriptOut, 'lippia_prop_bar.png'),
       plot = lippia_prop_bar,
       width = 12, height = 6, units = 'cm')


lippia_prop_bar
```

To better understand the compounding of strictures, we can look at the proportional loss of area between strictures- e.g. instead of looking at the proportion of wetland area utilized, we can look at the wetland area utilised as a fraction of that used in the preceding step to see how each stricture reduces the remaining area of favourability.

```{r}
#| label: fig-seq_lippia
#| fig-cap: !expr glue::glue("Proportion of remaining area lost for each successive stricture. Calculated as area of favourability after stricture x / area of favourability after stricture x-1. For the first stricture (germination), this denominator is simply the total wetland area. Example given for water year {demo_year}.")
seq_lippia <- sequential_lippia %>% 
  filter(waterYear == demo_year) %>% 
ggplot() +
  geom_sf(mapping = aes(fill = Proportional_area)) +
  scale_fill_continuous_sequential(palette = 'Heat', rev = FALSE) + 
  labs(fill = 'Proportion\nremaining area') + 
  facet_wrap('strict_level_F') + 
  theme(legend.position = 'bottom')

ggsave(file.path(scriptOut, 'seq_lippia.pdf'),
       plot = seq_lippia,
       width = 12, height = 6, units = 'cm')
ggsave(file.path(scriptOut, 'seq_lippia.png'),
       plot = seq_lippia,
       width = 12, height = 6, units = 'cm')

seq_lippia
```

In addition to varying across the basin, the impact of strictures also varies in time. The trajectory through time differs between catchments, shown as a timeseries for a selection (@fig-lippia-time ) and for a set of maps.

```{r}
#| label: fig-lippia-time
#| fig-cap: Area of wetlands favourable for Lippia following each successive stricture in each water year for a selection of catchments. 
lippia_time <- lippia %>% 
  filter(ValleyName %in% catch_subset) %>% 
ggplot(mapping = aes(x = waterYear, 
                     y = proportion_wetlands, 
                     color = strict_level_F)) +
  geom_line() +
  geom_point() +
  scale_color_discrete_qualitative(palette = 'Dark2') +
  facet_grid('ValleyName') +
  labs(color = 'Stricture\nlevel', x = 'Water Year', y = 'Proportion of wetlands favourable')

ggsave(file.path(scriptOut, 'lippia_time.pdf'),
       plot = lippia_time,
       width = 12, height = 12, units = 'cm')
ggsave(file.path(scriptOut, 'lippia_time.png'),
       plot = lippia_time,
       width = 12, height = 12, units = 'cm')

lippia_time
```

```{r}
#| label: fig-lippia-time-map
#| fig-cap: Area of wetlands favourable for Lippia following each successive stricture in each water year.
lippia_time_map <- sequential_lippia %>% 
ggplot() +
  geom_sf(mapping = aes(fill = Proportional_area)) +
  scale_fill_continuous_sequential(palette = 'Heat', rev = FALSE) + 
  labs(fill = 'Proportion\nremaining area') + 
  facet_grid(strict_level_F ~ waterYear, 
             labeller = labeller(strict_level_F = label_wrap_gen(10))) 

ggsave(file.path(scriptOut, 'lippia_time_map.pdf'),
       plot = lippia_time_map,
       width = 12, height = 12, units = 'cm')
ggsave(file.path(scriptOut, 'lippia_time_map.png'),
       plot = lippia_time_map,
       width = 12, height = 12, units = 'cm')

lippia_time_map
```

### Centipeda

Plots of *C. cunninghamii* success relative to wetland area and relative to the area of favourability remaining after preceding strictures are shown in the text. Here we provide additional figures to provide more context and accentuate different outcomes.

*C. cunninghamii* shows spatial variation in the area of favourability, and this persists through the sequence of strictures ( @fig-cent-area , @fig-cent-bar ). Unlike Lippia, the area of favourability noticeably drops at each step in the process.

```{r}
#| label: fig-cent-area
#| fig-cap: !expr glue::glue("Area of C. cunninghamii favourability following each successive stricture. Example given for water year {demo_year}")
cent_area <- centipeda %>% 
  filter(waterYear == demo_year) %>% 
ggplot() +
  geom_sf(mapping = aes(fill = area_passing/10000)) +
  facet_grid(. ~ strict_level_F, 
             labeller = labeller(strict_level_F = label_wrap_gen(15))) +
  scale_fill_continuous_sequential(palette = 'Turku', trans = 'log10') +
  labs(fill = 'Hectares\npassing') +
  theme(legend.position = 'bottom')

ggsave(file.path(scriptOut, 'cent_area.pdf'),
       plot = cent_area,
       width = 16, height = 6, units = 'cm')
ggsave(file.path(scriptOut, 'cent_area.png'),
       plot = cent_area,
       width = 16, height = 6, units = 'cm')


cent_area
```

```{r}
#| label: fig-cent-bar
#| fig-cap: !expr glue::glue("Area of wetlands favourable for C. cunninghamii following each successive stricture. Example given for water year {demo_year}")
cent_area_bar <- centipeda %>% 
  filter(waterYear == demo_year) %>% 
ggplot() +
  geom_col(mapping = aes(x = fct_reorder(ValleyName, catchment_area), 
                         y = area_passing/10000, 
                         fill = strict_level_F),
           position = position_dodge()) +
  scale_fill_discrete_qualitative(palette = 'Dark2') +
  labs(fill = 'Stricture', y = 'Hectares passing', x = NULL) +
  theme(legend.position = 'bottom') +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))+
  guides(fill = guide_legend(title.position = 'top', label.position = 'bottom'))


ggsave(file.path(scriptOut, 'cent_area_bar.pdf'),
       plot = cent_area_bar,
       width = 12, height = 6, units = 'cm')
ggsave(file.path(scriptOut, 'cent_area_bar.png'),
       plot = cent_area_bar,
       width = 12, height = 6, units = 'cm')

cent_area_bar
```

Maps of the proportion of successful wetlands and the conditional proportion of remaining wetland area are provided in the text, along with a bar plot of a selected set of catchments and strictures. When all strictures are plotted, the seed survival stricture is always near 1 and so obscures the others. Again removing that stricture, we see a range of responses for different catchments across the sequence of strictures ( @fig-cent-bar-prop ) , of which the plot in the text is a simpler subset.

```{r}
#| label: fig-cent-bar-prop
#| fig-cap: !expr glue::glue("Area of wetlands favourable for C. cunninghamii following each successive stricture, proportional to total wetland are in each catchment. Example given for water year {demo_year}. Catchments ordered by catchment area.")
cent_bar_no_seeds <- centipeda %>% 
  filter(waterYear == demo_year) %>% 
  filter(strict_level != 'seedsurv_centipeda') %>% 
ggplot() +
  geom_col(mapping = aes(x = fct_reorder(ValleyName, wetland_area), 
                         y = proportion_wetlands, 
                         fill = strict_level_F),
           position = position_dodge()) +
  scale_fill_discrete_qualitative(palette = 'Dark2') +
  labs(fill = 'Stricture', y = 'Proportion wetland area\nsuccessful', x = NULL) +
  theme(legend.position = 'bottom') +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  guides(fill = guide_legend(title.position = 'top', label.position = 'bottom'))

ggsave(file.path(scriptOut, 'cent_bar_no_seeds.pdf'),
       plot = cent_bar_no_seeds,
       width = 16, height = 6, units = 'cm')
ggsave(file.path(scriptOut, 'cent_bar_no_seeds.png'),
       plot = cent_bar_no_seeds,
       width = 16, height = 6, units = 'cm')

cent_bar_no_seeds
```

The stricture impacts vary across time and space. This is easiest to see when we remove seed survival, which is always approximately 1. Not only are there years that reduce the impacts of germination and fruiting strictures, these shifts happen differently across catchments @fig-cent-time .

```{r}
#| label: fig-cent-time
#| fig-cap: Area of wetlands favourable for C. cunninghamii following each successive stricture in each water year for a selection of catchments.
#| 
cent_time <- centipeda %>% 
  filter(ValleyName %in% catch_subset & 
           strict_level != "seedsurv_centipeda") %>% 
ggplot(mapping = aes(x = waterYear, 
                     y = proportion_wetlands, 
                     color = strict_level_F)) +
  geom_line() +
  geom_point() +
  scale_color_discrete_qualitative(palette = 'Dark2') +
  facet_grid('ValleyName') +
  labs(color = 'Stricture\nlevel', x = 'Water Year', y = 'Proportion of wetlands favourable')

ggsave(file.path(scriptOut, 'cent_time.pdf'),
       plot = cent_time,
       width = 16, height = 12, units = 'cm')
ggsave(file.path(scriptOut, 'cent_time.png'),
       plot = cent_time,
       width = 16, height = 12, units = 'cm')

cent_time
```

Looking at the timeseries of the conditional reduction in area, e.g. the proportion of remaining area lost at each step as in the middle row of Figure 7, we see that the impact of the different strictures differs between years and locations, indicating not only a shift in the dominant stricture, but also showing that strictures can mask each others' impacts. For example, the Lachlan shows an apparent tradeoff between fruiting and Lippia strictures, where heavy losses from fruiting leave little to further restrict from Lippia. Conversely, these two operate in parallel in Wimmera and Avoca, two catchments with relatively lower Lippa success ( @fig-lippia-prop-bar ).

```{r}
#| label: fig-sequential_conditional_timeseries
#| fig-cap: !expr glue::glue("Timeseries of proportion of remaining area lost for each successive stricture for C. cunninghamii. Calculated as area of favourability after stricture x / area of favourability after stricture x-1. For the first stricture (seed survival), this denominator is simply the total wetland area. Example given for water year {demo_year}.")
#| warning: false
sequential_conditional_timeseries <- sequential_cent %>% 
  filter(ValleyName %in% catch_subset) %>% 
ggplot(mapping = aes(x = waterYear, 
                     y = Proportional_area, 
                     color = strict_level_F)) +
  geom_line() +
  geom_point() +
  scale_color_discrete_qualitative(palette = 'Dark2') +
  facet_grid('ValleyName') +
  labs(color = 'Stricture\nlevel', x = 'Water Year', y = 'Proportion\nremaining area')

ggsave(file.path(scriptOut, 'sequential_conditional_timeseries.pdf'),
       plot = sequential_conditional_timeseries,
       width = 16, height = 12, units = 'cm')
ggsave(file.path(scriptOut, 'sequential_conditional_timeseries.png'),
       plot = sequential_conditional_timeseries,
       width = 16, height = 12, units = 'cm')

sequential_conditional_timeseries
```

Plotting these temporal shifts on a map ( @fig-conditional-timeseries-map ) illuminates the spatio-temporal patterns of shifting dominance of different strictures. By exploring the drivers of these shifts, much insight could be gained into the conditions and locations that would best relieve pinch points. Perhaps most importantly, they can also identify where removing one stricture simply leads to later loss of that area to a subsequent stricture.

```{r}
#| label: fig-conditional-timeseries-map
#| fig-cap: !expr glue::glue("Temporal shifts in proportion of remaining area lost for each successive stricture for C. cunninghamii. Calculated as area of favourability after stricture x / area of favourability after stricture x-1. For the first stricture (seed survival), this denominator is simply the total wetland area. Grey areas are locations where there was no remaining area, and so cause division by 0.")
#| warning: false
timeseries_map <- sequential_cent %>% 
ggplot() +
  geom_sf(mapping = aes(fill = Proportional_area)) +
  scale_fill_continuous_sequential(palette = 'Heat', rev = FALSE) + 
  labs(fill = 'Proportion\nremaining area') + 
  facet_grid(strict_level_F ~ waterYear) 


ggsave(file.path(scriptOut, 'timeseries_map.pdf'),
       plot = timeseries_map,
       width = 16, height = 16, units = 'cm')
ggsave(file.path(scriptOut, 'timeseries_map.png'),
       plot = timeseries_map,
       width = 16, height = 16, units = 'cm')

timeseries_map
```

# PAPER PLOTS- hide when render appendix

```{r}

proparea_cent_success_1 <- centipeda %>% 
  filter(waterYear == demo_year) %>% 
ggplot() +
  geom_sf(mapping = aes(fill = proportion_wetlands)) +
  facet_grid(.~strict_level_F, 
             labeller = labeller(strict_level_F = label_wrap_gen(20))) +
  scale_fill_continuous_sequential(palette = 'YlGnBu', trans = 'log10') + 
  labs(fill = 'Proportion\nwetland area\nsuccessful')

sequential_cent_plot_1 <- sequential_cent %>% 
  filter(waterYear == demo_year) %>% 
ggplot() +
  geom_sf(mapping = aes(fill = Proportional_area)) +
  scale_fill_continuous_sequential(palette = 'Heat', rev = FALSE) + 
  labs(fill = 'Proportion\nremaining area') + 
  facet_grid(.~strict_level_F, 
             labeller = labeller(strict_level_F = label_wrap_gen(20)))
```

```{r}
cent_bar_no_seeds_cut <- centipeda %>% 
  filter(waterYear == demo_year) %>% 
  filter(ValleyName %in% catch_subset) %>% 
  filter(strict_level != 'seedsurv_centipeda') %>% 
ggplot() +
  geom_col(mapping = aes(x = fct_reorder(ValleyName, wetland_area), 
                         y = proportion_wetlands, 
                         fill = strict_level_F),
           position = position_dodge()) +
  scale_fill_discrete_qualitative(palette = 'Dark2') +
  labs(fill = 'Stricture', y = 'Proportion wetland\narea successful', x = NULL) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))
```

```{r}

stackveg <- ggpubr::ggarrange(proparea_cent_success_1 +
    theme_grey(base_size = 8) + 
    theme(legend.position = 'right', 
          legend.background = element_blank(),
          legend.key.size = unit(0.3, 'cm')), 
    
                  sequential_cent_plot_1 +
    theme_grey(base_size = 8) + 
    theme(legend.position = 'right', 
          legend.background = element_blank(),
          legend.key.size = unit(0.3, 'cm')), 
    
                  cent_bar_no_seeds_cut +
    theme_grey(base_size = 8) + 
    theme(legend.position = 'right', 
          legend.background = element_blank(),
          legend.key.size = unit(0.3, 'cm')), 
    nrow = 3, heights = c(2,2,1))


ggsave(file.path(scriptOut, 'Veg_area_prop_bar.pdf'),
       plot = stackveg,
       width = 16, height = 12, units = 'cm')
ggsave(file.path(scriptOut, 'Veg_area_prop_bar.png'),
       plot = stackveg,
       width = 16, height = 12, units = 'cm')
# pdf(file = file.path(scriptOut, 'Veg_area_prop_bar.pdf'), 
#     width = 16/2.54, height = 12/2.54)
# stackveg
# dev.off()

# stackveg
```
